---
title: "Huito"
description: 'Label designer for multiple porpouses'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Huito}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
params:
  file: "huito"
resource_files:
  - huito
---

```{r setup, include=FALSE}
source("https://raw.githubusercontent.com/Flavjack/inti/master/pkgdown/favicon/docs.r")
# open https://docs.google.com/document/d/1U_06RwkOWavq2O9CY5j9GRd3_2Ik8OTrfszK-ccbGmQ/edit
```


```{r, include=FALSE}

# text <- doc$value[5]

figure_md <- function(text
                      , path = "."
                      , opts = NA
                      ) {
  
 opt <- text %>% 
   enframe() %>% 
   separate_rows(value, sep = "^(\\!\\[)") %>% 
   separate_rows(value, sep = "(\\]\\()") %>% 
   separate_rows(value, sep = "(\\)\\{)") %>% 
   separate_rows(value, sep = "(\\{)") %>% 
   separate_rows(value, sep = "(\\})") %>% 
   na_if("") %>% 
   drop_na(value) %>% 
   rownames_to_column() %>% 
   mutate(type = case_when(
     grepl("img_", value) ~ "figure"
     , grepl("#fig", value) ~ "id"
     , rowname %in% 1 ~ "title"
     , TRUE ~ "options"
   )) %>% 
   select(type, value) %>% 
   deframe() %>% 
   as.list()
 
 if(!is.na(opts)) {
   opt$options <- opts
 }
 
 fig <- paste0(
   "\n\n"
   , "```{r "
   , opt$options
   , ", fig.cap= '"
   , opt$title %>% trimws()
   , "'}\n\n"
   , "knitr::include_graphics('"
   , paste0(path, "/", opt$figure)
   , "')\n\n```"
   ) 
 
 fig
 
}

```

```{r, eval=T}
file <- params$file
zip <- list.files(pattern = ".zip"
                  , full.names = T
                  ) %>% 
  unzip(overwrite = T, exdir = file)

doc <- zip %>% 
    .[grep('.md', .)] %>%
    readLines() %>% 
    tibble::enframe() %>%
    rowwise() %>%
    dplyr::mutate(text = case_when(
      grepl(pattern = "fig:id", value) ~ value %>% figure_md(path = file)
      , TRUE ~ value
      )) %>% 
  select(text) %>% 
  tibble::deframe() %>% 
  writeLines(con = paste0(file,"/_doc.Rmd"))

doc <- list.files(path = file, pattern = "_doc", full.names = T)
```

```{r, echo=FALSE, results='asis', eval=T}
res <- knitr::knit_child(doc, quiet = TRUE)
cat(res, sep = '\n')
```


